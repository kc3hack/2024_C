<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <title>えぇgentとおしゃべりしよう!</title>
    </head>
    <body>
        <!--stack overflow, ループから抜け出す方法を教えてください, 
        https://ja.stackoverflow.com/questions/82445/%E3%83%AB%E3%83%BC%E3%83%97%E3%81%8B%E3%82%89%E6%8A%9C%E3%81%91%E5%87%BA%E3%81%99%E6%96%B9%E6%B3%95%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84
        最終閲覧日2024年2月16日.
        -->
        <h1>音声認識による対話</h1>
        <div id="japanese"></div>
        <p class="recognize-text">認識結果が表示されます</p>
        <button id="recognize">音声対話を開始する</button>
        <button id="recognize-end">音声対話を終了する</button>
        <div id="endMsg">入力完了と判定しました<br>入力：</div>
        <script>
            const textDisplay = document.querySelector('.recognize-text');
            let speech_recognition_state = 1 //状態0 音声認識を続ける, 状態1 音声認識を終える

            try {
            // 音声認識
            window.SpeechRecognition = window.SpeechRecognition || webkitSpeechRecognition;
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.continuous = false;
            recognition.interimResults = false;
            var reset = recognition.onend;

            // 認識スタート
            recognition.onstart = (e)=>{
                textDisplay.textContent = "認識中";
                textDisplay.style.color = "#aaa"
                console.log('Speech recognition service started')
            }   

            // 認識終了
            recognition.onresult = (e)=> {
                const str = e.results[0][0].transcript;
                textDisplay.textContent = str;

                if(e.results[0].isFinal){
                console.log(str);
                document.getElementById("myobj").value = str;
                document.getElementById("myobj").dispatchEvent(new Event('input'));
                }
            }
            
            // スタートボタン
            document.querySelector('#recognize').onclick = (e)=>{
                recognition.start();
                speech_recognition_state = 0; //音声認識を続けるに設定する
            }

            //　リセットループ
            recognition.onend = (e)=> { 
                console.log('reset')
                textDisplay.textContent = "認識完了";
                textDisplay.style.color = "#aaa"

                //続けるときのみ再度認識を行う
                if (speech_recognition_state == 0) {
                    recognition.start();
                }
            } 

            //終了ボタン
            document.getElementById('recognize-end').onclick = (e)=>{
                document.getElementById("myobj").value = ""
                speech_recognition_state = 1; //音声認識を終えるに設定する
                recognition.end();
            }

            recognition.onerror = function(event)  {
                console.log('音声認識エラーが検出されました：' + event.error);
            }
        
            } catch (error) {
            console.log(error);
            }
            </script>
            <input type="text" id="myobj" value="">
            <script>

            var myobj = document.getElementById("myobj");
            myobj.oninput = myfunc;
            var gTimer;
            function myfunc() {
                // =========================================================
                //   入力の度に実行される
                //     入力完了までタイマーで実行待ちする
                //     タイマーまでに次の入力があると、再度タイマー設定
                // =========================================================
                // --- サンプル用 メッセージ出力 -------------------
                var wObj = document.getElementById("endMsg");
                wObj.innerHTML = '入力中です';
                wObj.className = 'defStyle runStyle';
                // =============================================
                //   一定時間を待って入力完了と判断 
                // =============================================
                if(gTimer){clearTimeout(gTimer);}
                gTimer = setTimeout(inputEnd, 800);
            }
            function inputEnd(){
            // =========================================================
            //   タイマー時間経過で入力完了と判断
            // =========================================================
                // サンプル用の処理です。入れ替えて利用ください
                // 入力完了後のメッセージ入れ替え
                var wObj    = document.getElementById("endMsg");
                wObj.innerHTML = '入力完了と判定しました<br>入力：'+document.getElementById("myobj").value;
                wObj.className = 'defStyle endStyle';
            }
        </script>
    </body>
<html>